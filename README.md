## MeteorJS-ReactJS-Test-App

![Alt text](/readme/01-main-page.png)

### Описание

Данное приложение является тестом знаний по **ReactJS** и **MeteorJS**.

Приложение представляет собой одностраничный сайт с системой авторизации и CRUD-операциями. 

Связь клиент-сервер реализована посредством API full-stack фреймворка - **MeteorJS**. 
Клиентская модель представления реализована посредством **ReactJS** и управление данными посредством **Flux**.

#### Неавторизованный пользователь

Для неавторизованного пользователя имеется возможность лишь просматривать главную страницу.

Для продолжения работы с приложением необходимо пройти процедуру авторизации.

Система авторизации реализована на нативном для **MeteorJS** способе - API MeteorJS поддерживает связь с коллекцией Users, в котором хранится вся информация о пользователях.

Для обеспечения безопасности и REST-full подхода была отключина дефолтная функциональность фреймворка - автоматический "шаринг" коллекций из БД для клиента. Теперь, для получения данных из БД, клиенту необходимо отправить запрос на сервер, сервер удостоверится в валидности запроса, выполнит его и вернет данные.

Данная функциональность реализована с помощью "Publish/Subscribe" и "Method/Call".

##### Роутинг приложения

Клиентская часть приложения обертнута в "прослойку" реализующую роутинг. Для этого использовалась официальная библиотека "react-router".

Так же определена система проверки доступа к роутам - проверка наличия записи в локальном хранилище, говорящая о том, авторизован пользователь или нет. Эта запись помещается туда до рендеринга клиентской части и обновляется в зависимости от действий пользователя (авторизация/выход из системы).

##### Авторизация 

###### Представление

![Auth](/readme/02-auth-modal-open.gif)

Для системы авторизации заведен отдельный роут.

При переходе на него отображается модальное окно для авторизации уже имеющегося пользователя или регистрации нового.

![Auth](/readme/03-auth-form-switch.gif)

Модальное окно отрисовано посредством "компонент" **ReactJS** - одного "родителя" и двух "детей". Родитель содержит "представление" контейнера для панелей "авторизация" и "регистраиция", а так же событий на действие пользователя (переключение между панелями; вход в систему) 

###### Валидация данных

После ввода данных и их подтверждения, на стороне клиента происходит их валидация. В случае ошибки - появляется уведомление, которое является отдельной "компонентой" **ReactJS**.

![Auth](/readme/04-form-validation.gif)
![Auth](/readme/04-form-validation-2.gif)

###### Логика

На клиенте заведен класс для работы с пользователем. В случае авторизации/регистрации вызываются нативные методы Meteor для осущесвления данной функциональности. Все данный помещаются в коллекцию Users.

```javascript
const Auth = class Auth {
    constructor() {
        // code here
    }

    auth(params, callback) {
        // Native API Meteor call - Meteor.loginWithPassword()
    }

    registration(params, callback) {
        // Native API Meteor call - Accounts.createUser()
    }
}
```

На сервере в данном случае не было кастомного обработчика и фреймворк выполнял все сам.

После успешной авторизации/регистрации пользователю становится доступен основной контент

![Auth](/readme/05-auth.gif)

##### Главная страница

![home-page](/readme/home-page.png)

На главной странице пользователю доступны настройки и основной контент.

Дерево "компонент" ReactJS для главной страницы:

```
* <Home />
    - <Profile />
    - <Posts />
        + <Post Items />
            * <Comments />
                - <Comments Item/>
                - <Comments Item/>
                - /* and more */
         + <Post Items />
            * <Comments />
                - <Comments Item/>
                - <Comments Item/>
                - /* and more */
        + /* and more */
```

###### Настройка профиля

![profile](/readme/06-profile.gif)
![profile-form](/readme/07-profile-form.gif)

Пользователь имеет возможность редактировать свои данные. Данная функциональность реализована и на стороне клиента, и на стороне сервера по средствам "Methods/Call"

Связь Call-Methods представляют собой RPC.

На клиенте через Call вызываю реализованные Methods на сервере

```javascript
const User = class User  {
    constructor() {
        // code here
    }

    changeUsername(params, callback) {
        Meteor.call('user:changeUsername', this.userId, username, callback)
    }

    changeEmail(params, callback) {
        // Native API Meteor call - Accounts.createUser()
    }
}
```

На сервер получаю данные с клиента и провожу манипуляции с коллекцией в БД

```javascript
Meteor.methods({
      'user:changeUsername' : (id, newUsername) => {
        Meteor.users.update(id, {
          $set : {username : newUsername }
        });
        return Meteor.user();
      }
    });

    Meteor.methods({
      'user:changeEmail' : (id, newEmail) => {
        Meteor.users.update(id, {
          $set : {emails : [{ address : newEmail , verified : false}] }
        });
        return Meteor.user();;
      }
    });
```

После изменения данных на сервере, они автоматически изменяются на клиенте при помощи "установки состояний" ReactJS

![data-change](/readme/08-profile-change-one-field.gif)

###### Основной контент

![posts](/readme/09-posts.gif)

Контент на сайте - это записи из БД.

Для их получение реализована взаимосвязь клиент-сервер посредством "Publish/Subscribe" API из **MeteorJS**

Клиент инициирует "подписку" на данные с сервера и копирует их в кэш MiniMongo (хранилище на клиенте)

```javascript
const PostList = class PostList {
  constructor() {
    Meteor.subscribe('posts');
    this.Posts = new Mongo.Collection('posts');   
  }

  getList() {
    return this.Posts.find({}).fetch()
  }
}
```

Сервер же, при вызове "подписки", получает данные из "настоящей" серверной БД и возвращает "курсор" клиенту.

```javascript
Meteor.publish('posts', function () {
  return PostsConnection.find({}  );
});
```

####### Комментарии

Пользователь имеет возможность оставлять свои комментарии под записью и просматривать чужие.

![comments](/readme/10-comments.gif)

Клиент, данные о комментариях так же получает через "Publish/Subscribe" API.

Комментарии отсортированны по дате их публикации и при добавление/удаление коментария, тут же происходит рендеринг страницы и пользователь получает актуальное состояние.

![comments-add](/readme/11-comments-add.gif)
![comments-remove](/readme/12-comments-remove.gif)

Добавление/удаление комментария происходит так же, как и изменение данных пользователей, через "Call/Methods" API

Пользователь может удалять только свои комментарии. 

###### Выход из приложения

Выход из приложения реализован с помощью нативного метода 

```javascript
Meteor.logout(callback)
```

![comments-add](/readme/12-comments-remove.gif)